name: Build Clash Royale Menu

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.4'
    
    - name: Install dependencies and create libroot header
      run: |
        brew install ldid
        
        # Create libroot header in supports directory
        cat > supports/libroot.h << 'EOF'
        #ifndef LIBROOT_H
        #define LIBROOT_H
        
        #include <stdint.h>
        #include <stddef.h>
        #include <sys/param.h>
        #import <Foundation/Foundation.h>
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        
        // Core libroot functions
        const char *libroot_dyn_get_root_prefix(void);
        const char *libroot_dyn_get_jbroot_prefix(void);
        const char *libroot_dyn_get_boot_uuid(void);
        char *libroot_dyn_rootfspath(const char *path, char *resolvedPath);
        char *libroot_dyn_jbrootpath(const char *path, char *resolvedPath);
        
        // Convenience macros - fixed for proper string concatenation
        #define JBROOT_PATH_NSSTRING(path) [@"/var/jb" stringByAppendingString:path]
        #define JBROOT_PATH_CSTRING(cPath) "/var/jb" cPath
        
        #ifdef __cplusplus
        }
        #endif
        
        #endif
        EOF
        
    - name: Integrate Clash Royale menu
      run: |
        # Copy mobile menu files to sources
        cp mobile_menu.h sources/
        cp mobile_menu.m sources/
        cp -r kfd sources/
        
        # Replace HUDApp.mm with mobile menu initialization
        cat > sources/HUDApp.mm << 'EOF'
        #import "mobile_menu.h"
        
        __attribute__((constructor))
        static void initializeClashRoyaleMenu() {
            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                [MobileMenu sharedInstance];
            });
        }
        
        bool IsHUDEnabled(void) {
            return [[MobileMenu sharedInstance] isElixirHackEnabled];
        }
        
        void SetHUDEnabled(bool enabled) {
            if (enabled) {
                [[MobileMenu sharedInstance] enableElixirVisibility];
            } else {
                [[MobileMenu sharedInstance] disableElixirVisibility];
            }
        }
        EOF
        
        # Update Info.plist
        sed -i '' 's/ch.xxtou.hudapp/com.clash.royale.menu/g' Resources/Info.plist
        sed -i '' 's/TrollSpeed/ClashRoyaleMenu/g' Resources/Info.plist
        
    - name: Build with Xcode
      run: |
        xcodebuild clean build archive \
          -scheme TrollSpeed \
          -project TrollSpeed.xcodeproj \
          -sdk iphoneos \
          -destination 'generic/platform=iOS' \
          -archivePath ClashRoyaleMenu \
          CODE_SIGNING_ALLOWED=NO \
          HEADER_SEARCH_PATHS='$(inherited) $(SRCROOT)/supports'
        
    - name: Create .tipa
      run: |
        chmod 0644 Resources/Info.plist
        cp supports/entitlements.plist ClashRoyaleMenu.xcarchive/Products/
        
        cd ClashRoyaleMenu.xcarchive/Products/Applications
        codesign --remove-signature TrollSpeed.app || true
        cd ../..
        
        cd ClashRoyaleMenu.xcarchive/Products
        mv Applications Payload
        mv Payload/TrollSpeed.app Payload/ClashRoyaleMenu.app
        
        ldid -Sentitlements.plist Payload/ClashRoyaleMenu.app
        chmod 0644 Payload/ClashRoyaleMenu.app/Info.plist
        
        zip -qr ClashRoyaleMenu.tipa Payload
        cd ../..
        
        mkdir -p packages
        mv ClashRoyaleMenu.xcarchive/Products/ClashRoyaleMenu.tipa packages/
        
    - name: Upload TIPA
      uses: actions/upload-artifact@v4
      with:
        name: ClashRoyaleMenu-TIPA
        path: packages/*.tipa
        
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: menu-v1.0-${{ github.run_number }}
        files: packages/*.tipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
