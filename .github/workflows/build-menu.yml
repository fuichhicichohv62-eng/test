name: Build Clash Royale Menu

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install ldid
        
    - name: Create simple iOS app structure
      run: |
        # Create basic iOS app structure
        mkdir -p ClashRoyaleMenu.app
        
        # Copy our menu files
        cp mobile_menu.m ClashRoyaleMenu.app/
        cp mobile_menu.h ClashRoyaleMenu.app/
        
        # Copy KFD files
        cp -r kfd ClashRoyaleMenu.app/
        
        # Create basic Info.plist
        cat > ClashRoyaleMenu.app/Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>ClashRoyaleMenu</string>
            <key>CFBundleIdentifier</key>
            <string>com.clash.royale.menu</string>
            <key>CFBundleName</key>
            <string>ClashRoyaleMenu</string>
            <key>CFBundleVersion</key>
            <string>1.0</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0</string>
            <key>MinimumOSVersion</key>
            <string>14.0</string>
            <key>UIDeviceFamily</key>
            <array>
                <integer>1</integer>
                <integer>2</integer>
            </array>
        </dict>
        </plist>
        EOF
        
        # Create entitlements
        cat > entitlements.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>platform-application</key>
            <true/>
            <key>com.apple.private.security.no-container</key>
            <true/>
        </dict>
        </plist>
        EOF
        
    - name: Create .tipa
      run: |
        # Create Payload directory
        mkdir -p Payload
        mv ClashRoyaleMenu.app Payload/
        
        # Sign with ldid
        ldid -Sentitlements.plist Payload/ClashRoyaleMenu.app
        
        # Create .tipa
        zip -qr ClashRoyaleMenu.tipa Payload
        
        # Move to packages
        mkdir -p packages
        mv ClashRoyaleMenu.tipa packages/
        
    - name: Upload TIPA
      uses: actions/upload-artifact@v4
      with:
        name: ClashRoyaleMenu-TIPA
        path: packages/*.tipa
        
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: menu-v1.0-${{ github.run_number }}
        files: packages/*.tipa
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
